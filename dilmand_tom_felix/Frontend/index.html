<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Smart Lamp UI</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .lamp {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin: 20px auto;
      background-color: #222;
      box-shadow: 0 0 30px rgba(255, 255, 0, 0.1);
      transition: all 0.3s ease;
    }
    .status-box {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .controls {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, button {
      margin-top: 5px;
    }
    button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-right: 10px;
    }
    button:hover {
      background-color: #388e3c;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .morse-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .morse-section input[type="text"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    .morse-status {
      margin-top: 10px;
      padding: 10px;
      background-color: #f1f8e9;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<h1>ðŸ’¡ Smart Lamp Steuerung</h1>

<!-- Digitale Darstellung der physischen Lampe -->
<div class="lamp" id="lamp"></div>

<!-- Textuelle Statusanzeige -->
<div class="status-box" id="statusBox">Verbindung wird hergestellt...</div>

<section class="controls">
  <button id="toggleBtn" disabled>Lampe Einschalten</button>

  <label for="brightness">ðŸ”† Helligkeit:</label>
  <input type="range" id="brightness" min="0" max="100" value="100" disabled>
  <span id="brightnessValue">100%</span>

  <label for="color">ðŸŽ¨ Farbe:</label>
  <input type="color" id="color" value="#ffffff" disabled>

  <div class="morse-section">
    <label for="morseInput">ðŸ“¡ Morsecode-Nachricht:</label>
    <input type="text" id="morseInput" placeholder="Text eingeben..." disabled>
    <button id="morseBtn" disabled>Morsecode abspielen</button>
    <div class="morse-status" id="morseStatus" style="display: none;"></div>
  </div>
</section>

<script>
  const toggleBtn = document.getElementById("toggleBtn");
  const brightnessInput = document.getElementById("brightness");
  const brightnessValue = document.getElementById("brightnessValue");
  const colorInput = document.getElementById("color");
  const statusBox = document.getElementById("statusBox");
  const lamp = document.getElementById("lamp");
  const morseInput = document.getElementById("morseInput");
  const morseBtn = document.getElementById("morseBtn");
  const morseStatus = document.getElementById("morseStatus");

  let isOn = false;
  let brightness = 100;
  let color = "#ffffff";
  let socket = null;
  let isMorseActive = false;
  
  // WebSocket-Verbindung herstellen
  function connectWebSocket() {
    // WebSocket-URL bestimmen
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws`;
    
    // WebSocket erstellen
    socket = new WebSocket(wsUrl);
    
    // WebSocket-Event-Handling
    socket.onopen = function() {
      updateStatus("Verbindung hergestellt");
      enableControls(true);
      
      // Initialen Status anfragen
      sendCommand('getStatus');
    };
    
    socket.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        console.log("Nachricht empfangen:", data);
        
        if (data.type === 'getStatus' || data.type === 'status') {
          updateLampView(data.state);
        } else if (data.type === 'morseUpdate') {
          updateMorseStatus(data);
        } else if (data.type === 'error') {
          updateStatus(data.message, false);
        } else if (data.type === 'success') {
          updateStatus(data.message, true);
        }
      } catch (error) {
        console.error("Fehler beim Verarbeiten der Nachricht:", error);
      }
    };
    
    socket.onerror = function(error) {
      console.error("WebSocket-Fehler:", error);
      updateStatus("WebSocket-Verbindungsfehler", false);
      enableControls(false);
    };
    
    socket.onclose = function() {
      updateStatus("Verbindung getrennt. Versuche erneut zu verbinden...", false);
      enableControls(false);
      
      // Nach kurzer Zeit erneut verbinden
      setTimeout(connectWebSocket, 3000);
    };
  }
  
  function updateStatus(message, success = true) {
    statusBox.textContent = message;
    statusBox.style.backgroundColor = success ? "#e3f2fd" : "#ffebee";
  }

  function enableControls(enabled = true) {
    toggleBtn.disabled = !enabled;
    brightnessInput.disabled = !enabled;
    colorInput.disabled = !enabled;
    morseInput.disabled = !enabled || isMorseActive;
    morseBtn.disabled = !enabled || isMorseActive;
  }

  function sendCommand(command, value = null) {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      updateStatus("Keine Verbindung zum Server", false);
      return;
    }
    
    const message = {
      command: command
    };
    
    if (value !== null) {
      message.value = value;
    }
    
    console.log("Sende Befehl:", message);
    
    // Kommando als JSON-String senden
    socket.send(JSON.stringify(message));
  }

  function updateMorseStatus(data) {
    if (data.status === 'started') {
      isMorseActive = true;
      morseStatus.textContent = "Morsecode wird gesendet...";
      morseStatus.style.display = "block";
      morseBtn.disabled = true;
      morseInput.disabled = true;
    } else if (data.status === 'progress') {
      morseStatus.textContent = `Morsecode: ${data.progress}% abgeschlossen`;
    } else if (data.status === 'completed') {
      isMorseActive = false;
      morseStatus.textContent = "Morsecode vollstÃ¤ndig Ã¼bertragen";
      setTimeout(() => {
        morseStatus.style.display = "none";
        enableControls(true);
      }, 3000);
    }
  }

  toggleBtn.addEventListener("click", () => {
    const command = isOn ? 'off' : 'on';
    sendCommand(command);
  });

  brightnessInput.addEventListener("input", () => {
    brightness = Number(brightnessInput.value);
    brightnessValue.textContent = `${brightness}%`;
  });
  
  brightnessInput.addEventListener("change", () => {
    sendCommand('brightness', brightness);
  });

  colorInput.addEventListener("change", () => {
    color = colorInput.value;
    sendCommand('color', color);
  });

  morseBtn.addEventListener("click", () => {
    const text = morseInput.value.trim();
    if (text) {
      sendCommand('morse', text);
    }
  });

  // Zeigt die Lampe basierend auf realem Zustand
  function updateLampView(state) {
    isOn = state.poweredOn;
    brightness = state.brightness;
    color = state.color;

    lamp.style.backgroundColor = isOn ? color : "#222";
    lamp.style.opacity = isOn ? (brightness / 100).toString() : "0.2";

    statusBox.textContent = `Lampe ist ${isOn ? "AN" : "AUS"} | Farbe: ${color} | Helligkeit: ${brightness}%`;
    toggleBtn.textContent = isOn ? "Lampe Ausschalten" : "Lampe Einschalten";
    brightnessInput.value = brightness;
    brightnessValue.textContent = `${brightness}%`;
    colorInput.value = color;
  }

  // WebSocket-Verbindung beim Laden der Seite herstellen
  connectWebSocket();
</script>
</body>
</html>